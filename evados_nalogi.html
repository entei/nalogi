<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Evados nalogi</title>
	<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
	<script src="js/bootstrap-datepicker.js"></script>
	<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="css/datepicker.css">
	<style type="text/css">
		body {
		//	width: 500px;
			    width: 30%;
    			margin: 0 auto;
		}

		input {
			width: 150px;
		}

		#error {
			background: #FFCBCB;
			margin-bottom: 5px;
			border-radius: 3px;
			margin-bottom: 10px;
			text-align: center;
		}

		#result {
			border-top: 1px dotted gray;
		}

		#loading-image {
			position: absolute;
			top: 40%;
			left: 45%;
			z-index: 100
		} 
		#loading {
			opacity: 0.5;
			width: 100%;
			height: 100%;
			top: 0px;
			left: 0px;
			position: fixed;
			display: block;
			z-index: 99
		}
	</style>
</head>
<body class="well">
	<script type="text/javascript">
		$(document).ready(function(){
			var nowTemp = new Date(),
				now = (new Date(nowTemp.getFullYear(), nowTemp.getMonth(), nowTemp.getDate(), 0, 0, 0, 0));
			var debt;
			var $error = $("#error"),
				start_at = $('#start_at').datepicker({
					endDate: now 
				}).on('changeDate', function(ev){
					//console.log(end_at.datepicker('getDate').valueOf());
					if(ev.date.valueOf() > end_at.datepicker('getDate').valueOf()){
						$error.text('Дата погашения должна быть больше даты возникновения задолженноси');
						start_at.datepicker("update", end_at.datepicker('getDate'));
					}
				}),
				end_at = $('#end_at').datepicker({
					endDate: now
				}).on('changeDate', function(ev){
					//console.log(start_at.datepicker('getDate').valueOf());
					if(ev.date.valueOf() < start_at.datepicker('getDate').valueOf()){
						$error.text('Дата погашения должна быть больше даты возникновения задолженноси');
						end_at.datepicker("update", start_at.datepicker('getDate'));
					}
				}),
				rep = $('#rep').datepicker({
					
				});
				
			$('form').on('click', '#add-extra', function(){
				//var i = $('.extra').size() + 1;
				$('<p class="extraPayment"><input type="text" id="extraDate" name="extraDate" readonly/>	<input type="text" id="extraPay" name="extraPay" ></p>').appendTo($('.extra'));
				$('[name=extraDate]').datepicker({
					endDate: new Date(end_at)
				}).on('changeDate', function(ev){
					if(ev.date.valueOf() < start_at.datepicker('getDate').valueOf() || ev.date.valueOf()  > end_at.datepicker('getDate').valueOf()){
						console.log('wrong extra date!');
					}
				});
			});

			$('form').on('click', '#ok', function(){
				$('#penalty').text('');
				debt = $('input').first().val();
				//if extra present
				if($("[name=extraDate]").length  > 0 ){
					//console.log('extraPayment present');
					/*
					var extraDateEnd = ($("[name=extraDate]"));
					var extraDateStart  = start_at.datepicker('getDate').valueOf();
					var extraPay = ($('[name=extraPay]').val());
					var new_debt = debt - parseFloat(extraPay);

					getRefRate(debt, extraDateStart, extraDateEnd);
					
					//1 day later (+ 86400000)
					start_day_ms = (extraDateEnd.datepicker('getDate').valueOf() + 86400000 );
					getRefRate(new_debt, start_day_ms, end_at);

					*/
					var start_in_ms  = start_at.datepicker('getDate').valueOf();
					var end_in_ms = end_at.datepicker('getDate').valueOf();
					$("[name=extraDate]").each(function(index){
						end_at = $(this).datepicker('getDate').valueOf();
						//getRefRate(debt, start_in_ms, end);
						console.log("Debt: " + debt + " start: " + new Date(start_in_ms) + " end_at: " + new Date(end_at) );
						//debt -= parseFloat(extraPay);

						start_in_ms = end_at; //new start date
					});
						end_in_ms = 
						console.log("Debt: " + debt + " start: " + new Date(start_in_ms) + " end_at: " + new Date(end_in_ms) );
						//getRefRate(debt, start_in_ms, end);
					return;
				}
				
				$error.text('');
				if(!start_at.val() && !end_at.val() && !debt){
					$error.text("Указаны не все данные!");
					return;
				}
				//getRefRate(debt, start_at.end,end_at.datepicker().val()); // load ajax	
				start_at.datepicker('getDate').valueOf();
				getRefRate(debt, start_at, end_at);
			});

			function getRefRate(debt, start, end) {
				$("#loading").show();
				var date = end; //ms
				//var date =  end.datepicker().val();
			//	alert(date);
				var url = "http://www.nbrb.by/Services/XmlRefRate.aspx?onDate="+date,
					yql = 'http://query.yahooapis.com/v1/public/yql?q=' + encodeURIComponent('select * from xml where url="' + url + '"') + '&format=xml&callback=?',
					refRate = 0;
				$.ajax({
				    url: yql,
				    dataType: "jsonp",
				    type: 'GET',
				    success: function(res) {	
				    	var xmlDoc = $.parseXML(res.results[0]), // to xml object
				    	$xml = $(xmlDoc),
				    	refValue = $xml.find("Value").first().text();
				    	console.log(refValue);
				    	refRate = parseFloat(refValue);
				    	//console.log(penalty(debt, start, end, refRate)+ "<-------------here");
						$('#loading').hide();
						$('#penalty').prepend("<li>\n" + new Date(start) + "\t" + new Date(end) + "\t" + refRate + "\t" + penalty(debt, start, end, refRate)+"</li>");
						
					}
				});
			}

			function penalty(debt, start_at, end_at, ref_rate){
				console.log(daydiff(start_at, end_at) + "- - - day diff");
				return Math.round(debt * daydiff(start_at, end_at) * ref_rate/36000)
			}

			function daydiff(start_at, end_at) {
			//	return ((end_at.datepicker('getDate').getTime() -
			//	 start_at.datepicker('getDate').getTime())/86400000) + 1; //days
				console.log(end_at + "end_at time");
				return ((end_at - start_at)/ 86400000 + 1); // days
			}
		});
	</script>
		<div id="loading" style="display:none;">
			<img id="loading-image" src="img/loading.gif" alt="Loading..." />
		</div>  
		<div id="error"></div>
		<form class="form-horizontal" action="#">
			<div class="control-group">
				Cумма задолженности:
				<input type="text" name="debt" value="">
			</div>
			<div class="control-group">
				Дата возникновения задолженности:
				<input type="text" id="start_at" value="" readonly >
			</div>
			<div class="control-group">			
				Дата погашения:
				<input type="text" id="end_at" name="end_date" readonly value="">
			</div>
			Промежуточные платежи:
			<div class="extra">

			</div>
			<input type="button" class="btn" id="add-extra"value="Добавить"><br />
			<input type="button" class="btn btn-success" id="ok" value="Посчитать">
		</form>
		<div id="result">
			Дата ---- Дата Оплаты --- Ставка ------Пеня
			<span id="penalty"></span>
		</div> бел. рублей.
</body>
</html>